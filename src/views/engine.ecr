<html>
  <head>
    <% cell_size = "30px" %>
    <title>pixel_lang engine, <%= engine.name %></title>
    <!-- Enables zooming -->
    <style>
      #celllink {
        display: block;
        height: <%= cell_size %>;        
        width: <%= cell_size %>;
      }

      #cell {
        height: <%= cell_size %>;
        width: <%= cell_size %>;
      }

      #wrap { width: 800px; height: 500px; padding: 0; overflow: auto; }
      #zoom {
          -ms-zoom: <%= zoom %>;
          -moz-transform: scale(<%= zoom %>);
          -moz-transform-origin: 0 0;
          -o-transform: scale(<%= zoom %>);
          -o-transform-origin: 0 0;
          -webkit-transform: scale(<%= zoom %>);
          -webkit-transform-origin: 0 0;
      }
    </style>
    <!-- If this engine is playing (the user clicked the PLAY button) begin refreshing the page -->
    <% if playing %>
      <meta http-equiv="refresh" content="1">
    <% end %>
  </head>
  <body>
    <a href="/">Home</a>
    <br>
    <!-- Draws the board in a scrollable, zoomable div -->
    <table>
      <tr>
        <td>
          <div id="wrap">
            <div id="zoom">
              <table border="0" cellspacing="0" cellpadding="0" style="table-layout:fixed">
                <% (0...engine.instructions.height).each do |y| %>
                  <tr>
                  <% (0...engine.instructions.width).each do |x| %>
                      <% color = "##{engine.instructions[x, y].value.value.to_s 16}" %>
                      <td id="cell" bgcolor="<%= color %>">
                      <% #Render a marker if there are pistons on this instruction %>
                      <% if !(pistons = engine.pistons.select {|p| p.position_x == x && p.position_y == y}).empty? %>
                          <% if color[1..2].to_i(16) > 0x77 %> 
                            <% color = "#000000" %> 
                          <% else %> 
                            <% color = "#FFFFFF" %> 
                          <% end %>
                          <% if pistons.size == 1 %>
                            <% p_c = "?" %>
                            <% if pistons[0].direction == :up %>
                              <% p_c = "^" %>
                            <% elsif pistons[0].direction == :down %>
                              <% p_c = "v" %>
                            <% elsif pistons[0].direction == :left %>
                              <% p_c = "<" %>
                            <% elsif pistons[0].direction == :right %>
                              <% p_c = ">" %>
                            <% end %>
                            <center><a id="cell_link" style="color:<%= color %>;text-decoration:none;" href="/engines/<%= e_id %>/instructions/<%= x %>/<%= y %>"><%= p_c %></a></center>
                          <% elsif pistons.size < 10 %>
                            <center><a id="cell_link" style="color:<%= color %>;text-decoration:none;" href="/engines/<%= e_id %>/instructions/<%= x %>/<%= y %>"><%= pistons.size %></a></center>
                          <% else %>
                            <center><a id="cell_link" style="color:<%= color %>;text-decoration:none;" href="/engines/<%= e_id %>/instructions/<%= x %>/<%= y %>">+</a></center>
                          <% end %>  
                      <% else %>
                          <center><a id="cell_link" style="color:<%= color %>;text-decoration:none;" href="/engines/<%= e_id %>/instructions/<%= x %>/<%= y %>">&nbsp&nbsp&nbsp&nbsp</a></center>
                      <% end %>  
                      </td> 
                  <% end %>
                  </tr>
                <% end %>
              </table>
            </div>
          </div>
        </td>
        <td>
          <table border="1">
            <% engine.info.each do |info| %>
              <tr>
                <td><%= info[0] %></td>
                <td><%= info[1] %></td>
              </tr>
            <% end %>
          </table>          
        </td>
      </tr>
    </table>
    <% play_text = (playing ? "STOP" : "PLAY") %>
    <% play_url = (playing ? "/engines/#{e_id}/stop" : "/engines/#{e_id}/play") %>
    <table border="0">
      <tr>
        <td>
          <form action="/zoom/in" method="get">
            <input type=submit value="+"></input>
          </form>
        </td>
        <td>
          <form action="/zoom/out" method="get">
            <input type=submit value="-"></input>
          </form>
        </td>
        <td>
          <form action="/engines/<%= e_id %>/next" method="post">  
            Cycles: <input style="width:50px"name="cycles" type="number" value="1" width=50px></input>
            <input type="submit" value="Go!">
          </form>
        </td>
        <td>
          <a href="<%= play_url %>"><%= play_text %></a>
        </td>
        <td>
          <a href="/engines/<%= e_id %>/reset">RESET</a> 
        </td>
      </tr>
    </table>
    <p><%= engine.output %></p>
  </body>
</html>